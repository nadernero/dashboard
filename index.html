<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>لوحة تقييم الخدام</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts - Cairo -->
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700&display=swap" rel="stylesheet">
    <!-- Font Awesome 6 CDN for professional icons (corrected integrity attribute) -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" xintegrity="sha512-Fo3rlrZj/k7ujTnHg4CGR2D7kSs0V4LLanw2qksYuRlEzO+tcaEPQogQ0KaoGN26/zrn20ImR1DfuLWnOo7aBA==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <!-- XLSX library for reading Excel files -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <!-- React and ReactDOM CDNs -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <!-- Chart.js CDN -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <!-- Babel for JSX transformation in browser (for simplicity, in production use build tools) -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
        /* CSS Variables for consistent theming */
        :root {
            --primary-purple: #6a11cb;
            --secondary-blue: #2575fc;
            --gradient-start: #4a00e0; /* Deeper purple */
            --gradient-end: #8e2de2;   /* Richer purple */
            --light-blue-bg: #e0e7ff;
            --dark-text: #333;
            --light-text: #6b7280;
            --border-color: #a7c0f0;
            --background-light: #f0f2f5;
            --card-bg: #ffffff;
            --shadow-color: rgba(0,0,0,0.08);
            --hover-shadow-color: rgba(0,0,0,0.15);
        }

        body {
            font-family: 'Cairo', sans-serif;
            background-color: var(--background-light);
            direction: rtl; /* Ensure RTL for the entire body */
        }
        .gradient-bg {
            background: linear-gradient(135deg, var(--gradient-start) 0%, var(--gradient-end) 100%);
        }
        .card {
            background: var(--card-bg);
            border-radius: 16px;
            box-shadow: 0 8px 20px var(--shadow-color);
            padding: 24px;
            margin-bottom: 24px;
            transition: all 0.3s ease;
        }
        .card:hover {
            box-shadow: 0 12px 25px var(--hover-shadow-color);
            transform: translateY(-3px);
        }
        .file-input {
            border: 2px dashed var(--primary-purple);
            border-radius: 12px;
            padding: 40px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            background-color: var(--card-bg);
        }
        .file-input:hover {
            border-color: var(--secondary-blue);
            background-color: #eef2ff; /* Light blue tint */
        }
        .loading-screen {
            display: none;
            text-align: center;
            padding: 40px;
            background-color: var(--card-bg);
            border-radius: 16px;
            box-shadow: 0 8px 20px var(--shadow-color);
        }
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid var(--primary-purple);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        /* Custom scrollbar for better aesthetics */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb {
            background: #a0a0a0;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #777;
        }

        /* Modal specific styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }
        .modal-overlay.open {
            opacity: 1;
            visibility: visible;
        }
        .modal-content {
            background-color: #fff;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            max-width: 90%;
            max-height: 90%;
            overflow-y: auto;
            transform: translateY(-20px);
            opacity: 0;
            transition: transform 0.3s ease, opacity 0.3s ease;
        }
        .modal-overlay.open .modal-content {
            transform: translateY(0);
            opacity: 1;
        }

        /* Mind Map SVG Styling */
        .mind-map-node-text {
            font-family: 'Cairo', sans-serif;
            font-size: 14px;
            font-weight: 600;
            fill: var(--dark-text);
            text-anchor: middle;
            transition: fill 0.3s ease;
            user-select: none; /* Prevent text selection */
        }
        /* Specific text colors for root and categories for better contrast */
        .mind-map-node-text.root {
            fill: #ffffff;
        }
        .mind-map-node-text.category {
            fill: var(--dark-text); /* Ensure dark text on colored category nodes */
        }
        .mind-map-node-text.item {
            fill: var(--dark-text); /* Ensure dark text on colored item nodes */
        }

        .mind-map-line {
            stroke: #c0c0c0;
            stroke-width: 1.5;
            fill: none;
            transition: stroke 0.3s ease, stroke-width 0.3s ease;
        }
        .mind-map-line:hover {
            stroke: var(--gradient-end);
            stroke-width: 2.5;
        }
        .mind-map-rect {
            fill: var(--light-blue-bg);
            stroke: var(--border-color);
            stroke-width: 1;
            rx: 8;
            ry: 8;
            transition: fill 0.3s ease, stroke 0.3s ease;
            filter: url(#shadow); /* Apply shadow filter */
        }
        .mind-map-rect:hover {
            filter: url(#hover-shadow); /* Apply hover shadow filter */
        }
        
        /* Define hover shadow filter */
        #hover-shadow {
            filter: drop-shadow(0 4px 8px rgba(0,0,0,0.25));
        }

        /* Specific rect colors for root and categories/items based on performance */
        .mind-map-rect.root {
            fill: var(--primary-purple); /* Default root color */
            stroke: var(--gradient-start);
        }
        .mind-map-node-icon {
            color: var(--primary-purple);
        }
        .mind-map-node-icon.root {
            color: white;
        }

        /* Print specific styles */
        @media print {
            body {
                background-color: #fff !important;
                margin: 0;
                padding: 0;
            }
            .gradient-bg, footer, .file-input, .loading-screen, .modal-overlay, .tab-buttons, .filter-section, .print-button-container {
                display: none !important;
            }
            .container, main {
                margin: 0 !important;
                padding: 0 !important;
                width: 100% !important;
                box-shadow: none !important; /* Remove shadows for print */
                border: none !important; /* Remove borders for print */
            }
            .card {
                box-shadow: none !important;
                border: 1px solid #eee !important;
                margin-bottom: 10px !important;
                padding: 15px !important;
            }
            .mind-map-rect {
                filter: none !important; /* Remove shadow for print */
            }
            /* Ensure charts and SVG render correctly for print */
            canvas, svg {
                max-width: 100% !important;
                height: auto !important;
                display: block !important;
                visibility: visible !important;
                page-break-inside: avoid;
            }
            /* Ensure text is visible and not cut off */
            .mind-map-node-text {
                fill: #000 !important; /* Ensure black text for printing */
            }
        }

        /* Tooltip styles */
        .mind-map-tooltip {
            position: absolute;
            background-color: rgba(255, 255, 255, 0.95);
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            pointer-events: none; /* Allows mouse events to pass through to elements below */
            z-index: 10;
            max-width: 300px;
            text-align: right;
            line-height: 1.5;
            font-size: 13px;
            color: #333;
            transition: opacity 0.2s ease-in-out;
            opacity: 0;
            visibility: hidden;
        }
        .mind-map-tooltip.visible {
            opacity: 1;
            visibility: visible;
        }
        .mind-map-tooltip h4 {
            font-weight: bold;
            margin-bottom: 6px;
            display: flex;
            align-items: center;
        }
        .mind-map-tooltip h4 i {
            margin-left: 8px;
            font-size: 16px;
        }
        .mind-map-tooltip p {
            margin-bottom: 4px;
        }
    </style>
</head>
<body class="bg-gray-50">
    <!-- Main Title Section -->
    <div class="gradient-bg text-white text-center py-12 shadow-lg">
        <h1 class="text-4xl font-bold mb-4"><i class="fas fa-chart-bar fa-fw ml-2"></i> لوحة تحكم تقييم الخدام</h1>
        <p class="text-xl opacity-90">تحليل شامل لأداء الخدام عبر المحاور المختلفة</p>
    </div>

    <div class="container mx-auto px-6 py-8">
        <!-- File Upload Section -->
        <div class="card transform transition-all duration-300 hover:scale-102 hover:shadow-xl" id="fileUploadSection">
            <h2 class="text-2xl font-bold text-gray-800 mb-6 text-center"><i class="fas fa-upload fa-fw ml-2"></i> رفع ملف تقييم الخدام</h2>
            <div class="file-input" onclick="window.handleFileUploadClick()">
                <div class="text-6xl mb-4"><i class="fas fa-file-excel text-green-600"></i></div>
                <p class="text-lg font-semibold text-gray-700">اضغط هنا لرفع ملف Excel</p>
                <p class="text-gray-500 text-sm mt-2">يدعم ملفات .xlsx و .xls</p>
                <input type="file" id="excelFile" accept=".xlsx,.xls" style="display: none;" onchange="window.handleFileChange(event)">
            </div>
        </div>

        <!-- Loading Screen -->
        <div class="loading-screen" id="loadingScreen">
            <div class="spinner"></div>
            <p class="text-lg text-gray-600">جاري تحليل البيانات...</p>
        </div>

        <!-- React Dashboard Root -->
        <div id="react-dashboard-root"></div>
    </div>

    <!-- Footer Section -->
    <footer class="bg-gradient-to-r from-indigo-800 to-purple-900 text-white py-8 mt-12 shadow-inner">
        <div class="container mx-auto px-4">
          <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
            <div>
              <h3 class="text-lg font-bold mb-4 flex items-center">
                <i class="fas fa-star fa-fw ml-2"></i>
                نظام تقييم الخدام
              </h3>
              <p class="text-indigo-100">
                نظام متكامل لتقييم أداء الخدام في مختلف المجالات والخدمات، يساعد على تطوير العمل الخدمي.
              </p>
            </div>
            <div>
              <h3 class="text-lg font-bold mb-4">روابط سريعة</h3>
              <ul class="space-y-2">
                <li><a href="#" class="text-indigo-100 hover:text-white transition-colors"><i class="fas fa-home fa-fw ml-2"></i>الصفحة الرئيسية</a></li>
                <li><a href="#" class="text-indigo-100 hover:text-white transition-colors"><i class="fas fa-clipboard-list fa-fw ml-2"></i>تقييمات الخدام</a></li>
                <li><a href="#" class="text-indigo-100 hover:text-white transition-colors"><i class="fas fa-file-alt fa-fw ml-2"></i>تقارير الأداء</a></li>
                <li><a href="#" class="text-indigo-100 hover:text-white transition-colors"><i class="fas fa-envelope fa-fw ml-2"></i>تواصل معنا</a></li>
              </ul>
            </div>
            <div>
              <h3 class="text-lg font-bold mb-4">اتصل بنا</h3>
              <p class="text-indigo-100"><i class="fas fa-at fa-fw ml-2"></i>البريد الإلكتروني: nadernero2003@gmail.com</p>
              <p class="text-indigo-100"><i class="fas fa-phone fa-fw ml-2"></i>الهاتف: 01273332947</p>
              <p class="text-indigo-100"><i class="fas fa-map-marker-alt fa-fw ml-2"></i>العنوان: العبور، مصر</p>
            </div>
          </div>
          <div class="border-t border-indigo-700 mt-8 pt-6 text-center text-indigo-200">
            <p>© 2023 نظام تقييم الخدام. جميع الحقوق محفوظة.</p>
          </div>
        </div>
    </footer>

    <!-- Global Utility Functions (must be defined before React components and their usage) -->
    <script>
        // Global variables for React root and data
        let reactRoot = null;
        let globalDashboardData = [];

        /**
         * Safely parses a value to a float, handling null, undefined, empty strings, and non-numeric values.
         * Converts percentages (values > 1) to decimals.
         * @param {*} value - The value to parse.
         * @returns {number} The parsed float value, clamped between 0 and 1.
         */
        const safeParseFloat = (value) => {
            if (value === null || value === undefined || value === '' || value === '#N/A' || value === 0) return 0;
            
            let parsed = parseFloat(value);
            
            if (isNaN(parsed)) return 0;
            
            // Values should be between 0 and 1 (decimal percentages)
            // If value is greater than 1, assume it's a percentage and convert
            if (parsed > 1) {
                parsed = parsed / 100;
            }
            
            return Math.max(0, Math.min(1, parsed));
        };

        /**
         * Parses raw JSON data from Excel into a structured format for the dashboard.
         * Uses header names to map columns, making it more robust.
         * @param {Array<Array<any>>} jsonData - The raw JSON data from the Excel sheet.
         * @returns {Array<Object>} An array of parsed server data objects.
         */
        const parseExcelData = (jsonData) => {
            const parsedData = [];

            if (!jsonData || jsonData.length < 2) { // Need at least 2 rows: headers and one data row
                console.warn('No data or insufficient rows in Excel file.');
                return parsedData;
            }

            const headerRow = jsonData[0]; // Assuming first row is header
            const columnMap = {};

            // Normalize header names for mapping
            const normalizeHeader = (header) => String(header).trim().replace(/\s+/g, ' ').replace(/\n/g, ' ');

            // Define expected headers and their corresponding data keys
            const expectedHeaders = {
                'اسم الخادم': 'name',
                'الخدمة الحالية': 'service',
                'الفصل': 'class',
                'نسبة المحور 1': 'axis1',
                'نسبة المحور 2': 'axis2',
                'نسبة المحور 3': 'axis3',
                'نسبة المحور 4': 'axis4',
                'نسبة المحور 5': 'axis5',
                'نسبة المحور 6': 'axis6',
                'المتوسط العام': 'average',
                'نقاط القوة': 'strengths',
                'السليبات والضعف': 'weaknesses',
                'ملاحظات الأمين': 'notes' // This is the key for "ملاحظات الأمين"
            };

            // Build column map from actual headers to internal keys
            headerRow.forEach((header, index) => {
                const normalizedHeader = normalizeHeader(header);
                for (const key in expectedHeaders) {
                    if (normalizeHeader(key) === normalizedHeader) {
                        columnMap[expectedHeaders[key]] = index;
                        break;
                    }
                }
            });

            console.log('Parsed Excel Headers (columnMap):', columnMap);

            // Check if all essential columns are found
            const essentialColumns = ['name', 'average']; // Minimum required columns
            for (const col of essentialColumns) {
                if (columnMap[col] === undefined) {
                    console.warn(`Missing essential column: '${col}'. Data parsing might be incomplete.`);
                }
            }

            // Start parsing data from the row after the header (index 1)
            for (let i = 1; i < jsonData.length; i++) {
                const row = jsonData[i];
                // Skip empty rows or rows without a name
                if (!row || !row[columnMap.name] || String(row[columnMap.name]).trim() === '') {
                    continue;
                }

                const name = String(row[columnMap.name] || '').trim();
                
                // Only add data if name is present and not '#N/A'
                if (name && name !== '#N/A') {
                    const serverData = {
                        name: name,
                        service: String(row[columnMap.service] || 'غير محدد').trim(),
                        class: String(row[columnMap.class] || 'غير محدد').trim(),
                        axis1: safeParseFloat(row[columnMap.axis1]),
                        axis2: safeParseFloat(row[columnMap.axis2]),
                        axis3: safeParseFloat(row[columnMap.axis3]),
                        axis4: safeParseFloat(row[columnMap.axis4]),
                        axis5: safeParseFloat(row[columnMap.axis5]),
                        axis6: safeParseFloat(row[columnMap.axis6]),
                        average: safeParseFloat(row[columnMap.average]),
                        strengths: String(row[columnMap.strengths] || '').trim(),
                        weaknesses: String(row[columnMap.weaknesses] || '').trim(),
                        notes: String(row[columnMap.notes] || '').trim(), // Ensure 'notes' is correctly mapped here
                        fullName: name // Store full name for display
                    };
                    parsedData.push(serverData);
                    // Log the notes for each server for debugging
                    console.log(`Debug: Server: ${serverData.name}, Notes: "${serverData.notes}"`);
                }
            }
            console.log('Parsed Data from Excel (Full Array):', parsedData);
            return parsedData;
        };

        /**
         * Function to reset the UI to file upload state (global scope)
         */
        const resetToFileUpload = () => {
            document.getElementById('fileUploadSection').style.display = 'block';
            document.getElementById('loadingScreen').style.display = 'none';
            if (reactRoot) {
                // Unmount the React component if it's mounted
                reactRoot.render(null); 
            }
            globalDashboardData = []; // Clear global data
        };

        /**
         * Event handler for file input click (global scope)
         * Opens the file selection dialog.
         */
        window.handleFileUploadClick = () => {
            document.getElementById('excelFile').click();
        };

        /**
         * Event handler for file change (global scope)
         * Reads the Excel file and parses its data.
         * @param {Event} event - The file change event.
         */
        window.handleFileChange = (event) => {
            const file = event.target.files[0];
            if (!file) return;

            document.getElementById('fileUploadSection').style.display = 'none';
            document.getElementById('loadingScreen').style.display = 'block';

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const sheetName = workbook.SheetNames[0]; // Assume the first sheet
                    const worksheet = workbook.Sheets[sheetName];
                    const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });

                    const parsedData = parseExcelData(jsonData);
                    if (parsedData.length > 0) {
                        // Call renderDashboard which is defined after React components
                        renderDashboard(parsedData); 
                    } else {
                        // Use custom message instead of alert
                        window.showMessage('error', 'لم يتم العثور على بيانات صالحة في الملف. تأكد من أن الملف يحتوي على أسماء الخدام والنتائج.');
                        resetToFileUpload();
                    }
                } catch (error) {
                    // Handle file reading errors
                    window.showMessage('error', 'خطأ في قراءة الملف: ' + error.message);
                    console.error('File reading error:', error);
                    resetToFileUpload();
                } finally {
                    document.getElementById('loadingScreen').style.display = 'none';
                }
            };
            reader.readAsArrayBuffer(file);
        };
    </script>

    <!-- React Components (Babel needs to process this first) -->
    <script type="text/babel">
        // Destructure React Hooks directly from the global React object
        const { useState, useEffect, useMemo, useCallback, useRef } = React;
        
        /**
         * Custom Message Display Component.
         * @param {Object} props - Component props.
         * @param {Object} props.message - Message object { type: 'success'|'error'|'info', text: '...' }.
         * @param {function} props.onClose - Function to close the message.
         */
        const CustomMessage = ({ message, onClose }) => {
            if (!message) return null;

            const bgColor = message.type === 'error' ? 'bg-red-500' : 'bg-green-500';
            const icon = message.type === 'error' ? 'fas fa-exclamation-circle' : 'fas fa-check-circle';

            return (
                <div className={`fixed top-4 right-4 p-4 rounded-lg shadow-lg text-white z-50 flex items-center ${bgColor}`}>
                    <i className={`${icon} ml-2 text-xl`}></i>
                    <span>{message.text}</span>
                    <button onClick={onClose} className="mr-4 text-white font-bold text-lg">
                        <i className="fas fa-times"></i>
                    </button>
                </div>
            );
        };

        /**
         * Modal component to display a list of servers for a given performance level.
         * @param {Object} props - Component props.
         * @param {boolean} props.isOpen - Whether the modal is open.
         * @param {function} props.onClose - Function to close the modal.
         * @param {Object} props.level - The performance level object (e.g., { label: 'ممتاز', color: '#10b981', iconClass: 'star' }).
         * @param {Array<Object>} props.servers - Array of server objects belonging to this level.
         */
        const ServerListModal = ({ isOpen, onClose, level, servers }) => {
            if (!isOpen) return null;

            return (
                <div className={`modal-overlay ${isOpen ? 'open' : ''}`} onClick={onClose}>
                    <div className="modal-content w-full md:w-3/4 lg:w-1/2" onClick={(e) => e.stopPropagation()}>
                        <div className="flex justify-between items-center mb-6 pb-4 border-b border-gray-200">
                            <h2 className="text-2xl font-bold text-gray-800 flex items-center">
                                <i className={`fas fa-${level.iconClass} fa-fw mr-3 text-2xl`} style={{ color: level.color }}></i>
                                الخدام في مستوى: <span className="mr-2" style={{ color: level.color }}>{level.label}</span>
                            </h2>
                            <button onClick={onClose} className="text-gray-500 hover:text-gray-800 transition-colors text-2xl">
                                <i className="fas fa-times"></i>
                            </button>
                        </div>
                        <div className="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-4 max-h-96 overflow-y-auto pr-2">
                            {servers.length > 0 ? (
                                servers.map((server, index) => (
                                    <div key={index} className="bg-gray-50 p-3 rounded-lg border border-gray-200 flex flex-col shadow-sm">
                                        <p className="font-semibold text-gray-800 truncate mb-1" title={server.fullName || server.name}>
                                            {index + 1}. {server.fullName || server.name}
                                        </p>
                                        <p className="text-sm text-gray-600">
                                            <span className="font-medium ml-1">النسبة:</span> {((server.average || 0) * 100).toFixed(1)}%
                                        </p>
                                        <p className="text-sm text-gray-600">
                                            <span className="font-medium ml-1">الخدمة:</span> {server.service || 'غير محدد'}
                                        </p>
                                    </div>
                                ))
                            ) : (
                                <p className="col-span-full text-center text-gray-600 py-4">لا يوجد خدام في هذا المستوى.</p>
                            )}
                        </div>
                    </div>
                </div>
            );
        };

        /**
         * Calculates the path for a Bézier curve between two points.
         * @param {Object} source - The source point {x, y}.
         * @param {Object} target - The target point {x, y}.
         * @returns {string} The SVG path string.
         */
        const calculateBezierPath = (source, target) => {
            // Adjust control points for a smoother, more direct curve
            const controlPointX1 = source.x + 50; // Move control point slightly to the right of source
            const controlPointX2 = target.x - 50; // Move control point slightly to the left of target
            return `M${source.x},${source.y} C${controlPointX1},${source.y} ${controlPointX2},${target.y} ${target.x},${target.y}`;
        };

        /**
         * Tooltip component for MindMap nodes.
         * @param {Object} props - Component props.
         * @param {Object} props.server - The server data to display.
         * @param {Object} props.position - The position {x, y} for the tooltip.
         */
        const MindMapTooltip = ({ server, position }) => {
            if (!server || !position) return null;

            // Calculate position relative to the viewport
            // This assumes the tooltip is rendered outside the SVG but within a parent div
            // For true SVG-relative positioning, foreignObject inside SVG would be needed,
            // but for simplicity and better styling control, this is a good approach.
            const tooltipStyle = {
                top: `${position.y + 20}px`, // Offset below the node
                left: `${position.x + 20}px`, // Offset to the right of the node
                transform: 'translateX(-100%)', // Position to the left of the cursor/node
                right: 'auto', // Ensure it doesn't try to position from right
            };

            return (
                <div className="mind-map-tooltip visible" style={tooltipStyle}>
                    <h3 className="text-base font-bold text-gray-800 mb-2 flex items-center">
                        <i className="fas fa-user-circle ml-2 text-purple-600"></i>
                        {server.fullName || server.name}
                    </h3>
                    <p className="text-sm text-gray-700 mb-1">
                        <span className="font-semibold ml-1">الخدمة:</span> {server.service || 'غير محدد'}
                    </p>
                    <p className="text-sm text-gray-700 mb-1">
                        <span className="font-semibold ml-1">الفصل:</span> {server.class || 'غير محدد'}
                    </p>
                    <p className="text-sm text-gray-700 mb-2">
                        <span className="font-semibold ml-1">التقييم:</span> {((server.average || 0) * 100).toFixed(1)}%
                    </p>

                    {server.strengths && (
                        <p className="text-sm text-green-700 flex items-start">
                            <i className="fas fa-plus-circle ml-2 mt-1 flex-shrink-0"></i>
                            <span className="font-semibold ml-1">القوة:</span> {server.strengths}
                        </p>
                    )}
                    {server.weaknesses && (
                        <p className="text-sm text-red-700 flex items-start">
                            <i className="fas fa-minus-circle ml-2 mt-1 flex-shrink-0"></i>
                            <span className="font-semibold ml-1">الضعف:</span> {server.weaknesses}
                        </p>
                    )}
                    {server.notes && (
                        <p className="text-sm text-blue-700 flex items-start">
                            <i className="fas fa-info-circle ml-2 mt-1 flex-shrink-0"></i>
                            <span className="font-semibold ml-1">ملاحظات:</span> {server.notes}
                        </p>
                    )}
                </div>
            );
        };


        /**
         * React component for rendering a dynamic Mind Map using SVG.
         * Displays filtered data categories and sample items.
         * @param {Object} props - Component props.
         * @param {Array<Object>} props.data - The filtered data to display in the mind map.
         * @param {string} props.selectedService - The currently selected service from the filter.
         */
        const MindMap = ({ data, selectedService }) => { 
            const svgRef = useRef(null);
            const containerRef = useRef(null); // Ref for the parent div of SVG
            const [dimensions, setDimensions] = useState({ width: 800, height: 600 });
            const [hoveredNode, setHoveredNode] = useState(null); // For tooltip: { node: {}, clientX: 0, clientY: 0 }
            
            // Define performance levels for color coding
            const performanceColors = useMemo(() => ({
                excellent: '#10b981', // green
                veryGood: '#3b82f6',  // blue
                good: '#f59e0b',      // yellow
                acceptable: '#f97316', // orange
                weak: '#ef4444'       // red
            }), []);

            const getNodeColor = useCallback((average) => {
                if (average >= 0.9) return performanceColors.excellent;
                if (average >= 0.8) return performanceColors.veryGood;
                if (average >= 0.7) return performanceColors.good;
                if (average >= 0.6) return performanceColors.acceptable;
                return performanceColors.weak;
            }, [performanceColors]);

            // Prepare hierarchical data for the mind map
            const mindMapData = useMemo(() => {
                const nodes = new Map();
                const links = [];

                console.log('MindMap: selectedService:', selectedService);
                console.log('MindMap: initial data length:', data.length);

                // If no specific service is selected, show a prompt or a generic root
                if (selectedService === 'الكل' || !selectedService || data.length === 0) {
                    const root = { id: 'root-prompt', label: 'الرجاء اختيار خدمة لعرض الخريطة الذهنية', type: 'root', children: [], icon: 'fas fa-info-circle' };
                    nodes.set(root.id, root);
                    console.log('MindMap: Showing prompt/no data root.');
                    return { nodes, links };
                }

                // Filter data for the selected service
                const serviceData = data.filter(d => d.service === selectedService);
                console.log(`MindMap: serviceData for "${selectedService}" length:`, serviceData.length);

                if (serviceData.length === 0) {
                    const root = { id: 'root-no-data', label: `لا توجد بيانات للخادمة: ${selectedService}`, type: 'root', children: [], icon: 'fas fa-exclamation-triangle' };
                    nodes.set(root.id, root);
                    console.log('MindMap: No data for selected service, showing no data root.');
                    return { nodes, links };
                }

                // Calculate average for the selected service
                const serviceAverage = serviceData.reduce((sum, item) => sum + item.average, 0) / serviceData.length;
                const serviceLabel = `${selectedService} (${(serviceAverage * 100).toFixed(1)}%)`;
                const serviceNodeColor = getNodeColor(serviceAverage);

                // 1. Root Node: Selected Service
                const root = { id: 'service-root', label: serviceLabel, type: 'root', children: [], icon: 'fas fa-tags', average: serviceAverage, color: serviceNodeColor };
                nodes.set(root.id, root);

                // 2. Level 1: Classes within the selected service
                const uniqueClasses = Array.from(new Set(serviceData.map(d => d.class).filter(c => c && c.trim() !== '' && c !== 'غير محدد')));
                console.log('MindMap: Unique Classes:', uniqueClasses);
                
                uniqueClasses.forEach(cls => {
                    const classServers = serviceData.filter(d => d.class === cls);
                    const classAverage = classServers.reduce((sum, item) => sum + item.average, 0) / classServers.length;
                    const classLabel = `${cls} (${(classAverage * 100).toFixed(1)}%)`;
                    const classNodeColor = getNodeColor(classAverage);

                    const classNode = { id: `class-${cls}`, label: classLabel, type: 'category', parentId: root.id, average: classAverage, color: classNodeColor, icon: 'fas fa-school' };
                    nodes.set(classNode.id, classNode);
                    root.children.push(classNode.id);
                    links.push({ source: root.id, target: classNode.id });

                    // 3. Level 2: Servers within each class
                    classServers.forEach(server => {
                        const serverLabel = `${server.name} (${(server.average * 100).toFixed(1)}%)`;
                        const serverNodeColor = getNodeColor(server.average);
                        const serverNode = { id: `server-${server.name}`, label: serverLabel, type: 'item', parentId: classNode.id, average: server.average, color: serverNodeColor, icon: 'fas fa-user-circle', ...server }; // Pass full server data for tooltip
                        nodes.set(serverNode.id, serverNode);
                        links.push({ source: classNode.id, target: serverNode.id });
                    });
                });
                console.log('MindMap: Final Nodes:', nodes);
                console.log('MindMap: Final Links:', links);
                return { nodes, links };
            }, [data, selectedService, getNodeColor]);

            // Function to get estimated text width (rough approximation)
            const getTextWidth = (text, fontSize = 14, fontWeight = 600) => {
                // This is a rough estimate. For perfect sizing, one would render text to a hidden SVG element
                // and measure its bounding box, or use a canvas element.
                // For simplicity, a character-based estimate is used.
                const charWidth = fontSize * 0.6; // Average character width
                const fontWeightFactor = fontWeight > 400 ? 1.1 : 1; // Bold text is wider
                return text.length * charWidth * fontWeightFactor;
            };

            // Effect to update SVG dimensions on window resize and data change
            useEffect(() => {
                const updateDimensions = () => {
                    if (containerRef.current) {
                        const parentWidth = containerRef.current.clientWidth;
                        const parentHeight = containerRef.current.clientHeight;

                        let requiredWidth = 0;
                        let requiredHeight = 0;

                        const rootNode = mindMapData.nodes.get('service-root') || mindMapData.nodes.get('root-prompt') || mindMapData.nodes.get('root-no-data');
                        if (rootNode) {
                            const rootTextWidth = getTextWidth(rootNode.label);
                            const rootRectWidth = Math.max(150, rootTextWidth + (rootNode.icon ? 30 : 20));
                            requiredWidth += rootRectWidth; // Root node width
                            requiredWidth += 150; // Spacing after root

                            const classNodes = Array.from(mindMapData.nodes.values()).filter(node => node.type === 'category' && node.parentId === rootNode.id);
                            
                            let maxClassBranchHeight = 0;
                            let currentXOffsetForClasses = 0; // To track horizontal position of class branches

                            classNodes.forEach(classNode => {
                                const classTextWidth = getTextWidth(classNode.label);
                                const classRectWidth = Math.max(150, classTextWidth + (classNode.icon ? 30 : 20));
                                
                                const serverNodes = Array.from(mindMapData.nodes.values()).filter(node => node.type === 'item' && node.parentId === classNode.id);
                                
                                let currentBranchHeight = 0;
                                let maxServerWidthInBranch = 0;

                                serverNodes.forEach(serverNode => {
                                    const serverTextWidth = getTextWidth(serverNode.label);
                                    const serverRectWidth = Math.max(150, serverTextWidth + (serverNode.icon ? 30 : 20));
                                    maxServerWidthInBranch = Math.max(maxServerWidthInBranch, serverRectWidth);
                                    currentBranchHeight += 60; // Server node height + spacing
                                });
                                
                                // Account for class node height and spacing
                                currentBranchHeight += 60; 

                                maxClassBranchHeight = Math.max(maxClassBranchHeight, currentBranchHeight);
                                currentXOffsetForClasses += Math.max(classRectWidth, maxServerWidthInBranch) + 100; // Add max width of class/servers + spacing
                            });

                            requiredWidth += currentXOffsetForClasses; // Total width for classes and their servers
                            requiredHeight = Math.max(parentHeight, maxClassBranchHeight + 100); // Base height + max height of any class branch + padding
                            requiredWidth = Math.max(parentWidth, requiredWidth); // Ensure it's at least parent width

                        } else {
                            // If no data or prompt, use default parent dimensions
                            requiredWidth = parentWidth;
                            requiredHeight = parentHeight;
                        }
                        
                        setDimensions({
                            width: requiredWidth,
                            height: requiredHeight
                        });
                    }
                };
                updateDimensions(); // Initial dimensions
                window.addEventListener('resize', updateDimensions); // Add resize listener
                // Re-calculate dimensions when mindMapData changes
                const timeoutId = setTimeout(updateDimensions, 100); // Small delay to ensure nodes are in DOM for textWidth calculation if needed
                return () => {
                    window.removeEventListener('resize', updateDimensions);
                    clearTimeout(timeoutId);
                };
            }, [mindMapData]); // Dependency on mindMapData

            // Calculate positions for nodes
            const positionedNodes = useMemo(() => {
                const nodesMap = mindMapData.nodes;
                const calculatedPositions = new Map();

                const rootNode = nodesMap.get('service-root') || nodesMap.get('root-prompt') || nodesMap.get('root-no-data');
                if (!rootNode) return calculatedPositions;

                const rootX = 150; // Fixed X for root node
                const rootTextWidth = getTextWidth(rootNode.label);
                const rootRectWidth = Math.max(150, rootTextWidth + (rootNode.icon ? 30 : 20));

                // Position Level 1 (Classes) horizontally to the right of the root
                const classNodes = Array.from(nodesMap.values()).filter(node => node.type === 'category' && node.parentId === rootNode.id);
                
                let currentTotalBranchHeight = 0;
                const branchHeights = new Map();

                // First pass: calculate heights for each class branch
                classNodes.forEach(classNode => {
                    const serverNodes = Array.from(nodesMap.values()).filter(node => node.type === 'item' && node.parentId === classNode.id);
                    const branchHeight = (serverNodes.length * 60) + 60; // Each server takes 60px height (node + spacing), plus class node
                    branchHeights.set(classNode.id, branchHeight);
                    currentTotalBranchHeight += branchHeight;
                });

                const initialYOffset = (dimensions.height - currentTotalBranchHeight) / 2; // Center all branches vertically

                let currentClassY = initialYOffset;
                let currentClassX = rootX + rootRectWidth / 2 + 150; // Start classes after root with some spacing

                classNodes.forEach((classNode) => {
                    const classTextWidth = getTextWidth(classNode.label);
                    const classRectWidth = Math.max(150, classTextWidth + (classNode.icon ? 30 : 20));

                    calculatedPositions.set(classNode.id, { x: currentClassX, y: currentClassY + (branchHeights.get(classNode.id) / 2) - 20 }); // Center class node vertically within its branch

                    // Position Level 2 (Servers) vertically below each class node
                    const serverNodes = Array.from(nodesMap.values()).filter(node => node.type === 'item' && node.parentId === classNode.id);
                    let currentServerY = currentClassY + 60; // Initial offset below the class node

                    serverNodes.forEach((serverNode) => {
                        const serverTextWidth = getTextWidth(serverNode.label);
                        const serverRectWidth = Math.max(150, serverTextWidth + (serverNode.icon ? 30 : 20));
                        const serverX = currentClassX + (classRectWidth / 2) - (serverRectWidth / 2); // Align servers horizontally below class
                        
                        calculatedPositions.set(serverNode.id, { x: serverX, y: currentServerY });
                        currentServerY += 60; // Move down for the next server
                    });
                    
                    currentClassY += branchHeights.get(classNode.id); // Move down for the next class branch
                });

                // Set root node Y after all other nodes are positioned to truly center it
                const minNodeY = Array.from(calculatedPositions.values()).reduce((min, pos) => Math.min(min, pos.y), Infinity);
                const maxNodeY = Array.from(calculatedPositions.values()).reduce((max, pos) => Math.max(max, pos.y), -Infinity); 
                
                if (isFinite(minNodeY) && isFinite(maxNodeY)) {
                    const overallCenterY = (minNodeY + maxNodeY) / 2;
                    calculatedPositions.set(rootNode.id, { x: rootX, y: overallCenterY });
                } else {
                    calculatedPositions.set(rootNode.id, { x: rootX, y: dimensions.height / 2 });
                }


                return calculatedPositions;
            }, [mindMapData, dimensions]);

            // All generated nodes are visible in this new structure
            const visibleNodes = useMemo(() => {
                return Array.from(mindMapData.nodes.values());
            }, [mindMapData]);

            const visibleLinks = useMemo(() => {
                return mindMapData.links.map(link => {
                    const sourcePos = positionedNodes.get(link.source);
                    const targetPos = positionedNodes.get(link.target);
                    return {
                        source: sourcePos,
                        target: targetPos
                    };
                }).filter(link => link.source && link.target);
            }, [mindMapData, positionedNodes]);

            // Get the bounding rectangle of the SVG container for tooltip positioning
            const getSvgContainerRect = useCallback(() => {
                return containerRef.current ? containerRef.current.getBoundingClientRect() : null;
            }, []);

            // NOW, after all hooks are called, apply conditional rendering for the fallback message.
            if (mindMapData.nodes.size === 1 && (mindMapData.nodes.has('root-prompt') || mindMapData.nodes.has('root-no-data'))) {
                const fallbackNode = mindMapData.nodes.values().next().value;
                return (
                    <div className="bg-gradient-to-br from-white to-gray-50 p-8 rounded-xl shadow-lg border border-gray-100 text-center h-full min-h-[600px] flex flex-col items-center justify-center">
                        <i className={`${fallbackNode.icon} fa-fw mx-auto text-gray-400 mb-4 text-5xl`}></i> {/* Changed concatenation to template literal */}
                        <h3 className="text-xl font-bold text-gray-700">{fallbackNode.label}</h3>
                        {fallbackNode.id === 'root-prompt' && <p className="text-gray-500">يرجى استخدام قائمة "نوع الخدمة" في الأعلى لتحديد خدمة معينة.</p>}
                    </div>
                );
            }

            // Construct the viewBox string using string concatenation
            const svgViewBox = "0 0 " + dimensions.width + " " + dimensions.height;

            return (
                <div ref={containerRef} className="bg-white p-6 rounded-2xl shadow-lg border border-gray-100 h-full min-h-[600px] flex items-center justify-center overflow-x-auto relative">
                    <svg ref={svgRef} width={dimensions.width} height={dimensions.height} viewBox={svgViewBox}>
                        <defs>
                            {/* Define shadow filter for nodes */}
                            <filter id="shadow" x="-50%" y="-50%" width="200%" height="200%">
                                <feDropShadow dx="2" dy="2" stdDeviation="3" floodColor="#000" floodOpacity="0.2"/>
                            </filter>
                             {/* Define hover shadow filter for nodes */}
                            <filter id="hover-shadow" x="-50%" y="-50%" width="200%" height="200%">
                                <feDropShadow dx="0" dy="4" stdDeviation="8" floodColor="#000" floodOpacity="0.25"/>
                            </filter>
                        </defs>
                        {/* Render links (lines connecting nodes) */}
                        {visibleLinks.map((link, index) => (
                            <path 
                                key={index}
                                d={calculateBezierPath(link.source, link.target)}
                                className="mind-map-line"
                            />
                        ))}
                        {/* Render nodes (rectangles with text) */}
                        {visibleNodes.map((node, index) => {
                            const position = positionedNodes.get(node.id);
                            if (!position) return null; // Node not positioned (e.g., collapsed)

                            const textWidth = getTextWidth(node.label);
                            let rectWidth = Math.max(150, textWidth + (node.icon ? 30 : 20)); // Base width

                            // Adjust width for server nodes based on average
                            if (node.type === 'item') {
                                rectWidth = Math.max(rectWidth, 150 + (node.average * 80)); // Scale width by average, max 230
                            }

                            const rectHeight = 40;
                            const rectX = position.x - rectWidth / 2;
                            const rectY = position.y - rectHeight / 2;

                            // Determine fill color based on node type and average
                            let fillColor = '';
                            let strokeColor = '';
                            let textColor = 'var(--dark-text)'; // Default text color

                            if (node.type === 'root') {
                                fillColor = node.color || 'var(--primary-purple)';
                                strokeColor = node.color || 'var(--gradient-start)'; 
                                textColor = '#ffffff'; // White for root text
                            } else if (node.type === 'category') { // Classes
                                fillColor = node.color ? node.color + '20' : '#a7c0f0'; // Lighter tint of average color
                                strokeColor = node.color || 'var(--primary-purple)';
                            } else { // Items (Servers)
                                fillColor = node.color || 'var(--light-blue-bg)'; // Use full color for server nodes
                                strokeColor = node.color || 'var(--border-color)';
                                textColor = 'var(--dark-text)'; // Ensure black text for server names
                            }

                            // Pre-calculate icon color
                            let iconColor = node.type === 'root' ? 'white' : 'var(--primary-purple)';
                            if (node.type === 'item') { // Ensure server icons match rect color if desired, or keep default
                                iconColor = node.color;
                            }


                            return (
                                <g 
                                    key={node.id} 
                                    onMouseEnter={(e) => {
                                        if (node.type === 'item') {
                                            const svgRect = svgRef.current.getBoundingClientRect();
                                            setHoveredNode({
                                                node: node,
                                                clientX: e.clientX - svgRect.left, // X relative to SVG
                                                clientY: e.clientY - svgRect.top, // Y relative to SVG
                                            });
                                        }
                                    }}
                                    onMouseLeave={() => setHoveredNode(null)}
                                >
                                    <rect 
                                        x={rectX} y={rectY} 
                                        width={rectWidth} height={rectHeight} 
                                        rx="8" ry="8"
                                        style={{ fill: fillColor, stroke: strokeColor, strokeWidth: 1 }}
                                        className="mind-map-rect" /* Add class for hover effect */
                                    />
                                    {node.icon && (
                                        <foreignObject x={rectX + 10} y={rectY + 8} width="24" height="24"> {/* Icon on the right */}
                                            <i className={node.icon + " text-lg"} style={{ color: iconColor }}></i>
                                        </foreignObject>
                                    )}
                                    <text 
                                        x={rectX + (node.icon ? 30 : 15)} // Adjust text position if icon is present
                                        y={position.y + 5} 
                                        className={"mind-map-node-text " + node.type}
                                        style={{ fill: textColor }}
                                        textLength={rectWidth - (node.icon ? 40 : 30)} // Adjust text length to fit, leaving padding
                                        lengthAdjust="spacingAndGlyphs"
                                    >
                                        {node.label}
                                    </text>
                                </g>
                            );
                        })}
                    </svg>
                    {hoveredNode && (
                        <MindMapTooltip 
                            server={hoveredNode.node} 
                            position={{ 
                                x: hoveredNode.clientX + getSvgContainerRect().left, 
                                y: hoveredNode.clientY + getSvgContainerRect().top 
                            }} 
                        />
                    )}
                </div>
            );
        };

        /**
         * Main React component for the Server Evaluation Dashboard.
         * Manages data, filters, sorting, tabs, and renders charts and server lists.
         * @param {Object} props - Component props.
         * @param {Array<Object>} props.initialData - Initial data loaded from the Excel file.
         */
        window.ServerEvaluationDashboard = ({ initialData }) => { /* Made global for renderDashboard */
            const [data, setData] = useState([]); // Original data from Excel
            const [filteredData, setFilteredData] = useState([]); // Data after applying filters and sort
            const [selectedService, setSelectedService] = useState('الكل');
            const [selectedClass, setSelectedClass] = useState('الكل');
            const [loading, setLoading] = useState(true);
            const [expandedServers, setExpandedServers] = useState({});
            const [activeTab, setActiveTab] = useState('dashboard'); // 'dashboard', 'servers', 'mindmap'
            const [performanceSort, setPerformanceSort] = useState('desc'); // 'desc' for highest, 'asc' for lowest
            const [selectedServerFilter, setSelectedServerFilter] = useState('الكل'); // For actual server filter
            const [isModalOpen, setIsModalOpen] = useState(false);
            const [modalContent, setModalContent] = useState({ level: null, servers: [] });
            const [viewMode, setViewMode] = useState('grid'); // 'grid' or 'list'
            const [message, setMessage] = useState(null); // { type: 'success'|'error'|'info', text: '...' }

            // State for AI suggestions
            const [generatedSuggestions, setGeneratedSuggestions] = useState({}); // { serverName: "suggestions text" }
            const [isGeneratingSuggestions, setIsGeneratingSuggestions] = useState({}); // { serverName: boolean }

            // Refs for Chart.js canvases
            const radarChartRef = useRef(null);
            const serviceDoughnutChartRef = useRef(null); 
            const chartInstance = useRef({}); // To store Chart.js instances for multiple charts

            // Diverse colors for charts - EXPANDED FOR MORE DISTINCTNESS
            const chartColors = [
                '#6a11cb', '#2575fc', '#6dd5ed', '#4facfe', '#0cbaba', '#00c6fb', '#005bea', '#00d2ff',
                '#ff7e5f', '#feb47b', '#ffc72c', '#f7b731', '#f97316', '#ff4b1f', '#f02fc2', '#6094ea',
                '#a1c4fd', '#c2e9fb', '#cfd9ed', '#e0c3fc', '#8ec5fc', '#e0a9f8', '#c9ffbf', '#ffafbd',
                '#a7e9af', '#ffc3a0', '#ffc72c', '#c3a0ff', '#a0c3ff', '#ff8c7a', '#7affc3', '#c3ff8c'
            ];
            
            // Function to show custom message
            window.showMessage = (type, text) => { // Made global for use in global script
                setMessage({ type, text });
                setTimeout(() => setMessage(null), 5000); // Clear after 5 seconds
            };

            // Set initial data and loading state when initialData prop changes
            useEffect(() => {
                if (initialData && initialData.length > 0) {
                    setData(initialData);
                    setLoading(false);
                } else {
                    setLoading(false); 
                }
            }, [initialData]);

            // Filtering and Sorting Logic: Recalculates filteredData whenever dependencies change
            useEffect(() => {
                let currentFiltered = [...data]; // Start with a copy of original data

                // Apply Service Filter
                if (selectedService !== 'الكل') {
                    currentFiltered = currentFiltered.filter(item => item.service === selectedService);
                }
                
                // Apply Class Filter
                if (selectedClass !== 'الكل') {
                    currentFiltered = currentFiltered.filter(item => item.class === selectedClass);
                }
                
                // Apply Server Name Filter
                if (selectedServerFilter !== 'الكل') {
                    currentFiltered = currentFiltered.filter(item => item.name === selectedServerFilter);
                }

                // Apply Sorting based on performanceSort state
                const sortedData = [...currentFiltered].sort((a, b) => {
                    const scoreA = a.average || 0;
                    const scoreB = b.average || 0;
                    return performanceSort === 'desc' ? scoreB - scoreA : scoreA - b.average;
                });

                setFilteredData(sortedData);
            }, [data, selectedService, selectedClass, selectedServerFilter, performanceSort]); // Dependencies for this effect

            // Extract unique services from the data for filter dropdown
            const services = useMemo(() => {
                const serviceSet = new Set(data.map(item => item.service).filter(s => s && s.trim() !== '' && s !== 'غير محدد'));
                return ['الكل', ...Array.from(serviceSet)];
            }, [data]);

            // Extract unique classes based on the selected service for filter dropdown
            const classesForService = useMemo(() => {
                let classes = [];
                if (selectedService === 'الكل') {
                    classes = data.map(item => item.class).filter(c => c && c.trim() !== '' && c !== 'غير محدد');
                } else {
                    classes = data
                        .filter(item => item.service === selectedService)
                        .map(item => item.class)
                        .filter(c => c && c.trim() !== '' && c !== 'غير محدد');
                }
                const classSet = new Set(classes);
                return ['الكل', ...Array.from(classSet)];
            }, [data, selectedService]);

            // Extract unique server names for filter dropdown
            const serverNames = useMemo(() => {
                const nameSet = new Set(data.map(item => item.name).filter(n => n && n.trim() !== ''));
                return ['الكل', ...Array.from(nameSet).sort()];
            }, [data]);

            // Calculate general statistics based on filtered data
            const statistics = useMemo(() => {
                if (filteredData.length === 0) {
                    return {
                        totalServers: 0,
                        avgScore: '0.0',
                        topPerformer: 'لا يوجد',
                        topScore: '0.0',
                        excellentCount: 0,
                        excellentPercentage: '0.0',
                        improvementCount: 0
                    };
                }
                
                const validData = filteredData.filter(item => !isNaN(item.average) && item.average > 0);
                if (validData.length === 0) {
                    return {
                        totalServers: 0,
                        avgScore: '0.0',
                        topPerformer: 'لا يوجد',
                        topScore: '0.0',
                        excellentCount: 0,
                        excellentPercentage: '0.0',
                        improvementCount: 0
                    };
                }
                
                const totalServers = validData.length;
                const avgScore = validData.reduce((sum, item) => sum + item.average, 0) / totalServers;
                const topPerformer = validData.reduce((prev, current) => (prev.average > current.average) ? prev : current);
                const excellentCount = validData.filter(item => item.average >= 0.9).length;
                const improvementCount = validData.filter(item => item.average < 0.7).length;
                
                return {
                    totalServers,
                    avgScore: isNaN(avgScore) ? '0.0' : (avgScore * 100).toFixed(1),
                    topPerformer: topPerformer.name,
                    topScore: isNaN(topPerformer.average) ? '0.0' : (topPerformer.average * 100).toFixed(1),
                    excellentCount,
                    excellentPercentage: totalServers > 0 ? ((excellentCount / totalServers) * 100).toFixed(1) : '0.0',
                    improvementCount
                };
            }, [filteredData]);

            // Prepare data for the Radar Chart (average scores per axis)
            const axisData = useMemo(() => {
                if (filteredData.length === 0) return [];
                
                const axisNames = [
                    'الجانب الروحي والشخصي',
                    'الالتزام والانضباط', 
                    'مهارات الأداء في الخدمة',
                    'العمل الجماعي والعلاقات',
                    'النمو والتطوير',
                    'تقديم الدرس'
                ];
                
                return axisNames.map((name, index) => {
                    const axisKey = `axis${index + 1}`; // Corresponds to axis1, axis2, etc.
                    const validValues = filteredData.filter(item => !isNaN(item[axisKey]) && item[axisKey] >= 0);
                    const avg = validValues.length > 0 
                        ? validValues.reduce((sum, item) => sum + item[axisKey], 0) / validValues.length 
                        : 0;
                    
                    return {
                        axis: name,
                        value: parseFloat((avg * 100).toFixed(1)), // Convert to percentage for display
                        fullMark: 100 // Max value for radar chart scale
                    };
                });
            }, [filteredData]);

            // Prepare data for the Service Distribution Doughnut Chart
            const serviceDoughnutData = useMemo(() => {
                const serviceCounts = {};
                filteredData.forEach(item => {
                    const serviceName = item.service || 'غير محدد';
                    serviceCounts[serviceName] = (serviceCounts[serviceName] || 0) + 1;
                });

                const labels = Object.keys(serviceCounts);
                const dataValues = Object.values(serviceCounts);

                return {
                    labels: labels,
                    datasets: [{
                        data: dataValues,
                        backgroundColor: chartColors.slice(0, labels.length), // Use available colors
                        borderColor: '#fff',
                        borderWidth: 2,
                    }]
                };
            }, [filteredData]);

            // Effect hook for rendering the Radar Chart using Chart.js
            useEffect(() => {
                if (radarChartRef.current && axisData.length > 0 && typeof Chart !== 'undefined') {
                    const ctx = radarChartRef.current.getContext('2d');

                    // Destroy existing chart instance if it exists to prevent duplicates
                    if (chartInstance.current.radar) {
                        chartInstance.current.radar.destroy();
                    }

                    // Create new Chart.js Radar Chart
                    chartInstance.current.radar = new Chart(ctx, {
                        type: 'radar',
                        data: {
                            labels: axisData.map(item => item.axis),
                            datasets: [{
                                label: 'متوسط التقييم',
                                data: axisData.map(item => item.value),
                                backgroundColor: 'rgba(136, 132, 216, 0.6)', /* Consistent with header gradient */
                                borderColor: '#6a11cb',
                                borderWidth: 2,
                                pointBackgroundColor: '#6a11cb',
                                pointBorderColor: '#fff',
                                pointHoverBackgroundColor: '#fff',
                                pointHoverBorderColor: '#6a11cb'
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            scales: {
                                r: {
                                    angleLines: {
                                        color: '#e0e7ff' /* Lighter gray for grid */
                                    },
                                    grid: {
                                        color: '#e0e7ff'
                                    },
                                    pointLabels: {
                                        font: {
                                            size: 12,
                                            family: 'Cairo, sans-serif'
                                        },
                                        color: '#4b5563'
                                    },
                                    suggestedMin: 0,
                                    suggestedMax: 100,
                                    ticks: {
                                        display: false // Hide ticks to keep it clean
                                    }
                                }
                            },
                            plugins: {
                                legend: {
                                    display: true,
                                    position: 'top',
                                    labels: {
                                        font: {
                                            family: 'Cairo, sans-serif'
                                        },
                                        color: '#374151'
                                    }
                                },
                                tooltip: {
                                    callbacks: {
                                        label: function(context) {
                                            return `${context.dataset.label}: ${context.raw}%`;
                                        }
                                    },
                                    titleFont: {
                                        family: 'Cairo, sans-serif'
                                    },
                                    bodyFont: {
                                        family: 'Cairo, sans-serif'
                                    },
                                    rtl: true
                                }
                            }
                        }
                    });
                }
                // Cleanup function to destroy chart on component unmount or dependency change
                return () => {
                    if (chartInstance.current.radar) {
                        chartInstance.current.radar.destroy();
                    }
                };
            }, [axisData, activeTab]); // Re-render if axisData or activeTab changes

            // Effect hook for rendering the Doughnut Chart using Chart.js
            useEffect(() => {
                if (serviceDoughnutChartRef.current && serviceDoughnutData.labels.length > 0 && typeof Chart !== 'undefined') {
                    const ctx = serviceDoughnutChartRef.current.getContext('2d');

                    // Destroy existing chart instance if it exists
                    if (chartInstance.current.doughnut) {
                        chartInstance.current.doughnut.destroy();
                    }

                    // Create new Chart.js Doughnut Chart
                    chartInstance.current.doughnut = new Chart(ctx, {
                        type: 'doughnut',
                        data: serviceDoughnutData,
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: {
                                    position: 'right', // Position legend to the right
                                    labels: {
                                        font: {
                                            family: 'Cairo', 
                                        },
                                        color: '#374151',
                                    },
                                    rtl: true, // Enable RTL for legend
                                },
                                tooltip: {
                                    callbacks: {
                                        label: function(context) {
                                            const label = context.label || '';
                                            const value = context.raw;
                                            const total = context.dataset.data.reduce((sum, val) => sum + val, 0);
                                            const percentage = ((value / total) * 100).toFixed(1);
                                            return `${label}: ${value} (${percentage}%)`;
                                        }
                                    },
                                    titleFont: {
                                        family: 'Cairo',
                                    },
                                    bodyFont: {
                                        family: 'Cairo',
                                    },
                                    rtl: true
                                }
                            }
                        }
                    });
                }
                // Cleanup function
                return () => {
                    if (chartInstance.current.doughnut) {
                        chartInstance.current.doughnut.destroy();
                    }
                };
            }, [serviceDoughnutData, activeTab]); // Re-render if serviceDoughnutData or activeTab changes


            // Define performance levels and categorize filtered data into them
            const performanceLevels = useMemo(() => {
                const levels = [
                    { label: 'ممتاز', min: 0.9, color: '#10b981', bgColor: 'bg-green-500', iconClass: 'star' },
                    { label: 'جيد جداً', min: 0.8, max: 0.89, color: '#3b82f6', bgColor: 'bg-blue-500', iconClass: 'chart-line' },
                    { label: 'جيد', min: 0.7, max: 0.79, color: '#f59e0b', bgColor: 'bg-yellow-500', iconClass: 'book-open' },
                    { label: 'مقبول', min: 0.6, max: 0.69, color: '#f97316', bgColor: 'bg-orange-500', iconClass: 'users' },
                    { label: 'ضعيف', min: 0, max: 0.59, color: '#ef4444', bgColor: 'bg-red-500', iconClass: 'exclamation-circle' }
                ];
                
                return levels.map(level => {
                    const serversInLevel = filteredData.filter(item => 
                        !isNaN(item.average) &&
                        item.average >= level.min && 
                        (!('max' in level) || item.average <= level.max) // Check max if defined
                    );
                    
                    return {
                        ...level,
                        count: serversInLevel.length,
                        percentage: filteredData.length > 0 ? (serversInLevel.length / filteredData.length) * 100 : 0,
                        servers: serversInLevel // Store the actual servers for the modal display
                    };
                });
            }, [filteredData]); // Recalculate if filteredData changes

            /**
             * Toggles the expansion state of a server's details.
             * @param {string} name - The name of the server.
             */
            const toggleServerDetails = (name) => {
                setExpandedServers(prev => ({
                    ...prev,
                    [name]: !prev[name]
                }));
            };

            /**
             * Resets all filter and sort selections to their default values.
             */
            const resetFilters = () => {
                setSelectedService('الكل');
                setSelectedClass('الكل');
                setSelectedServerFilter('الكل'); 
                setPerformanceSort('desc'); 
            };

            /**
             * Opens the server list modal with servers belonging to a specific performance level.
             * @param {Object} level - The performance level object (e.g., { label: 'ممتاز', color: '#10b981', iconClass: 'star' }).
             * @param {Array<Object>} servers - Array of server objects belonging to this level.
             */
            const openServerListModal = (level) => {
                setModalContent({ level: level, servers: level.servers });
                setIsModalOpen(true);
            };

            /**
             * Closes the server list modal.
             */
            const closeServerListModal = () => {
                setIsModalOpen(false);
                setModalContent({ level: null, servers: [] });
            };

            /**
             * Generates AI-powered suggestions for server improvement based on their data.
             * Uses the Gemini API for text generation.
             * Implements exponential backoff for API retries.
             * @param {Object} server - The server object for which to generate suggestions.
             * @returns {Promise<void>}
             */
            const generateSuggestionsForServer = async (server) => {
                setIsGeneratingSuggestions(prev => ({ ...prev, [server.name]: true })); // Set loading state for this server
                setGeneratedSuggestions(prev => ({ ...prev, [server.name]: '' })); // Clear previous suggestions

                const prompt = `
                أنا أقيم أداء خادم في خدمة كنسية. بناءً على المعلومات التالية، يرجى تقديم 3-5 اقتراحات محددة وقابلة للتنفيذ لمساعدته على تحسين أدائه. ركز على الجوانب التي يمكن تطويرها بناءً على نقاط الضعف والملاحظات.
                
                اسم الخادم: ${server.name}
                الخدمة: ${server.service}
                الفصل: ${server.class}
                نقاط القوة: ${server.strengths || 'لا توجد'}
                نقاط الضعف: ${server.weaknesses || 'لا توجد'}
                ملاحظات الأمين: ${server.notes || 'لا توجد'}
                
                يرجى تقديم الاقتراحات في شكل قائمة نقطية.
                `;

                let chatHistory = [];
                chatHistory.push({ role: "user", parts: [{ text: prompt }] });
                const payload = { contents: chatHistory };
                const apiKey = ""; // API key is provided by the environment if empty
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;

                let retries = 0;
                const maxRetries = 5;
                let delay = 1000; // Initial delay of 1 second

                while (retries < maxRetries) {
                    try {
                        const response = await fetch(apiUrl, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(payload)
                        });

                        if (!response.ok) {
                            if (response.status === 429) { // Too Many Requests (rate limiting)
                                throw new Error('Too Many Requests');
                            }
                            throw new Error(`HTTP error! status: ${response.status}`);
                        }

                        const result = await response.json();
                        if (result.candidates && result.candidates.length > 0 &&
                            result.candidates[0].content && result.candidates[0].content.parts &&
                            result.candidates[0].content.parts.length > 0) {
                            const text = result.candidates[0].content.parts[0].text;
                            setGeneratedSuggestions(prev => ({ ...prev, [server.name]: text }));
                            break; // Success, exit retry loop
                        } else {
                            throw new Error('Unexpected API response structure or missing content');
                        }
                    } catch (error) {
                        console.error(`Error generating suggestions for ${server.name}:`, error);
                        retries++;
                        if (retries < maxRetries) {
                            await new Promise(res => setTimeout(res, delay)); // Wait before retrying
                            delay *= 2; // Exponential backoff
                        } else {
                            // Max retries reached, display error message
                            window.showMessage('error', `حدث خطأ أثناء توليد الاقتراحات للخادم ${server.name}. يرجى المحاولة مرة أخرى.`);
                            setGeneratedSuggestions(prev => ({ ...prev, [server.name]: 'تعذر توليد الاقتراحات.' }));
                        }
                    }
                }
                setIsGeneratingSuggestions(prev => ({ ...prev, [server.name]: false })); // Reset loading state
            };

            /**
             * Renders the doughnut chart for service distribution.
             * @returns {JSX.Element} The doughnut chart component or a message if no data.
             */
            const renderServiceDistributionChart = () => {
                if (serviceDoughnutData.labels.length === 0) {
                    return <div className="text-center py-8 text-gray-500">لا توجد بيانات</div>;
                }
                return (
                    <div className="bg-gradient-to-br from-white to-gray-50 p-6 rounded-2xl shadow-lg border border-gray-100 mt-8">
                        <h2 className="text-xl font-bold text-gray-800 mb-4 flex items-center">
                            <i className="fas fa-chart-pie fa-fw ml-2 text-xl"></i>
                            التوزيع حسب نوع الخدمة
                        </h2>
                        <div style={{ height: '300px' }}>
                            <canvas ref={serviceDoughnutChartRef}></canvas>
                        </div>
                    </div>
                );
            };

            /**
             * Renders the performance levels section with counts and percentages.
             * @returns {JSX.Element} The performance levels section or null if no data.
             */
            const renderPerformanceLevels = () => {
                if (performanceLevels.length === 0) {
                    return null;
                }
                return (
                    <div className="bg-gradient-to-br from-white to-gray-50 p-6 rounded-xl shadow-lg border border-gray-100 mb-6">
                        <h2 className="text-xl font-bold text-gray-800 mb-4 flex items-center">
                            <i className="fas fa-chart-bar fa-fw ml-2 text-xl"></i>
                            توزيع الدرجات حسب المستويات
                        </h2>
                        <div className="grid grid-cols-1 md:grid-cols-5 gap-4">
                            {performanceLevels.map((level, index) => (
                                <button 
                                    key={index} 
                                    onClick={() => openServerListModal(level)}
                                    className="flex flex-col items-center bg-white p-4 rounded-lg shadow-sm border border-gray-100 transform transition-all duration-200 hover:scale-105 hover:shadow-md cursor-pointer"
                                >
                                    <div 
                                        className="w-16 h-16 rounded-full flex items-center justify-center mb-2"
                                        style={{ backgroundColor: level.color + '20', border: `2px solid ${level.color}` }}
                                    >
                                        <span className="font-bold text-lg" style={{ color: level.color }}>
                                            {level.count}
                                        </span>
                                    </div>
                                    <div className="flex items-center mb-1">
                                        <i className={`fas fa-${level.iconClass} fa-fw mr-1 text-lg`}></i>
                                        <p className="text-center font-medium">{level.label}</p>
                                    </div>
                                    <p className="text-gray-600">{level.percentage.toFixed(1)}%</p>
                                </button>
                            ))}
                        </div>
                    </div>
                );
            };

            return (
                <div className="min-h-screen bg-gradient-to-b from-gray-50 to-gray-100" dir="rtl">
                    {/* Navigation Header */}
                    <header className="bg-gradient-to-r from-purple-800 to-indigo-900 text-white shadow-lg">
                        <div className="container mx-auto px-4 py-4 flex justify-between items-center">
                            <div className="flex items-center">
                                <div className="bg-white p-2 rounded-full mr-3 shadow-md">
                                    <i className="fas fa-star text-purple-700 text-2xl"></i>
                                </div>
                                <h1 className="text-2xl font-bold">لوحة تقييم الخدام</h1>
                            </div>
                            <div className="flex space-x-4 tab-buttons">
                                {/* Dashboard Tab Button */}
                                <button 
                                    className={`px-4 py-2 rounded-lg flex items-center font-medium transition-all duration-200 ${activeTab === 'dashboard' ? 'bg-white text-purple-700 shadow-md' : 'text-white hover:bg-white/20'}`}
                                    onClick={() => setActiveTab('dashboard')}
                                >
                                    <i className="fas fa-chart-bar fa-fw ml-2 text-lg"></i>
                                    الإحصائيات
                                </button>
                                {/* Servers List Tab Button */}
                                <button 
                                    className={`px-4 py-2 rounded-lg flex items-center font-medium transition-all duration-200 ${activeTab === 'servers' ? 'bg-white text-purple-700 shadow-md' : 'text-white hover:bg-white/20'}`}
                                    onClick={() => setActiveTab('servers')}
                                >
                                    <i className="fas fa-users fa-fw ml-2 text-lg"></i>
                                    قائمة الخدام
                                </button>
                                {/* Mind Map Tab Button */}
                                <button 
                                    className={`px-4 py-2 rounded-lg flex items-center font-medium transition-all duration-200 ${activeTab === 'mindmap' ? 'bg-white text-purple-700 shadow-md' : 'text-white hover:bg-white/20'}`}
                                    onClick={() => setActiveTab('mindmap')}
                                >
                                    <i className="fas fa-sitemap fa-fw ml-2 text-lg"></i>
                                    خريطة ذهنية
                                </button>
                            </div>
                            {/* Print/Save PDF Button */}
                            <div className="print-button-container">
                                <button 
                                    onClick={() => window.print()}
                                    className="px-4 py-2 rounded-lg flex items-center font-medium bg-white text-purple-700 shadow-md hover:bg-gray-100 transition-all duration-200"
                                >
                                    <i className="fas fa-print fa-fw ml-2 text-lg"></i>
                                    طباعة PDF
                                </button>
                            </div>
                        </div>
                    </header>

                    {/* Main Content Area */}
                    <main className="container mx-auto px-4 py-8">
                        {loading ? (
                            // Loading spinner when data is being processed
                            <div className="flex justify-center items-center h-64">
                                <div className="animate-spin rounded-full h-16 w-16 border-t-4 border-b-4 border-purple-500"></div>
                            </div>
                        ) : (
                            <>
                                {/* Filter Section */}
                                <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-8 filter-section">
                                    {/* Service Type Filter */}
                                    <div className="bg-gradient-to-br from-white to-gray-50 p-4 rounded-xl shadow-md border border-gray-100">
                                        <label className="block text-sm font-medium text-gray-700 mb-2 flex items-center">
                                            <i className="fas fa-tag fa-fw ml-2 text-lg text-purple-600"></i>
                                            نوع الخدمة
                                        </label>
                                        <div className="relative">
                                            <select 
                                                value={selectedService}
                                                onChange={(e) => setSelectedService(e.target.value)}
                                                className="w-full p-3 border border-gray-300 rounded-lg appearance-none pr-10 bg-white text-gray-800 focus:ring-2 focus:ring-purple-500 focus:border-transparent transition-all duration-200"
                                            >
                                                {services.map(service => (
                                                    <option key={service} value={service}>{service}</option>
                                                ))}
                                            </select>
                                            <div className="absolute left-3 top-1/2 -translate-y-1/2 text-gray-500 pointer-events-none">
                                                <i className="fas fa-chevron-down fa-fw text-sm"></i>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    {/* Class Filter */}
                                    <div className="bg-gradient-to-br from-white to-gray-50 p-4 rounded-xl shadow-md border border-gray-100">
                                        <label className="block text-sm font-medium text-gray-700 mb-2 flex items-center">
                                            <i className="fas fa-school fa-fw ml-2 text-lg text-purple-600"></i>
                                            الفصل
                                        </label>
                                        <div className="relative">
                                            <select 
                                                value={selectedClass}
                                                onChange={(e) => setSelectedClass(e.target.value)}
                                                className="w-full p-3 border border-gray-300 rounded-lg appearance-none pr-10 bg-white text-gray-800 focus:ring-2 focus:ring-purple-500 focus:border-transparent transition-all duration-200"
                                            >
                                                {classesForService.map(cls => (
                                                    <option key={cls} value={cls}>{cls}</option>
                                                ))}
                                            </select>
                                            <div className="absolute left-3 top-1/2 -translate-y-1/2 text-gray-500 pointer-events-none">
                                                <i className="fas fa-chevron-down fa-fw text-sm"></i>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    {/* Server Name Filter */}
                                    <div className="bg-gradient-to-br from-white to-gray-50 p-4 rounded-xl shadow-md border border-gray-100">
                                        <label className="block text-sm font-medium text-gray-700 mb-2 flex items-center">
                                            <i className="fas fa-user-circle fa-fw ml-2 text-lg text-purple-600"></i>
                                             اســم الخادم
                                        </label>
                                        <div className="relative">
                                            <select 
                                                value={selectedServerFilter}
                                                onChange={(e) => setSelectedServerFilter(e.target.value)}
                                                className="w-full p-3 border border-gray-300 rounded-lg appearance-none pr-10 bg-white text-gray-800 focus:ring-2 focus:ring-purple-500 focus:border-transparent transition-all duration-200"
                                            >
                                                {serverNames.map(name => (
                                                    <option key={name} value={name}>{name}</option>
                                                ))}
                                            </select>
                                            <div className="absolute left-3 top-1/2 -translate-y-1/2 text-gray-500 pointer-events-none">
                                                <i className="fas fa-chevron-down fa-fw text-sm"></i>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    {/* Reset Filters Button */}
                                    <div className="flex items-end">
                                        <button 
                                            onClick={resetFilters}
                                            className="w-full py-3 bg-gray-200 hover:bg-gray-300 text-gray-800 rounded-lg flex items-center justify-center font-medium transition-all duration-200 transform hover:scale-102 shadow-md"
                                        >
                                            <i className="fas fa-sync-alt fa-fw ml-2 text-lg"></i>
                                            إعادة تعيين الفلاتر
                                        </button>
                                    </div>
                                </div>

                                {/* Conditional rendering based on activeTab */}
                                {activeTab === 'dashboard' ? (
                                    <>
                                        {/* General Statistics Section */}
                                        {statistics && statistics.totalServers > 0 ? (
                                            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                                                {/* Total Servers Card */}
                                                <div className="bg-gradient-to-br from-white to-gray-50 p-5 rounded-2xl shadow-lg border border-gray-100 flex items-center transform transition-all duration-300 hover:scale-102 hover:shadow-xl">
                                                    <div className="bg-blue-100 p-3 rounded-xl mr-4 flex-shrink-0">
                                                        <i className="fas fa-users text-blue-600 text-3xl"></i>
                                                    </div>
                                                    <div>
                                                        <p className="text-gray-500 text-sm">عدد الخدام</p>
                                                        <p className="text-2xl font-bold text-gray-800">{statistics.totalServers}</p>
                                                    </div>
                                                </div>
                                                
                                                {/* Average Score Card */}
                                                <div className="bg-gradient-to-br from-white to-gray-50 p-5 rounded-2xl shadow-lg border border-gray-100 flex items-center transform transition-all duration-300 hover:scale-102 hover:shadow-xl">
                                                    <div className="bg-green-100 p-3 rounded-xl mr-4 flex-shrink-0">
                                                        <i className="fas fa-chart-line text-green-600 text-3xl"></i>
                                                    </div>
                                                    <div>
                                                        <p className="text-gray-500 text-sm">متوسط التقييم</p>
                                                        <p className="text-2xl font-bold text-gray-800">{statistics.avgScore}%</p>
                                                    </div>
                                                </div>
                                                
                                                {/* Top Performer Card */}
                                                <div className="bg-gradient-to-br from-white to-gray-50 p-5 rounded-2xl shadow-lg border border-gray-100 flex items-center transform transition-all duration-300 hover:scale-102 hover:shadow-xl">
                                                    <div className="bg-yellow-100 p-3 rounded-xl mr-4 flex-shrink-0">
                                                        <i className="fas fa-trophy text-yellow-600 text-3xl"></i>
                                                    </div>
                                                    <div>
                                                        <p className="text-gray-500 text-sm">أعلى تقييم</p>
                                                        <p className="text-xl font-bold text-gray-800 truncate" title={statistics.topPerformer}>{statistics.topPerformer}</p>
                                                        <p className="text-gray-600 text-sm">{statistics.topScore}%</p>
                                                    </div>
                                                </div>
                                                
                                                {/* Excellent Servers Count Card */}
                                                <div className="bg-gradient-to-br from-white to-gray-50 p-5 rounded-2xl shadow-lg border border-gray-100 flex items-center transform transition-all duration-300 hover:scale-102 hover:shadow-xl">
                                                    <div className="bg-purple-100 p-3 rounded-xl mr-4 flex-shrink-0">
                                                        <i className="fas fa-star text-purple-600 text-3xl"></i>
                                                    </div>
                                                    <div>
                                                        <p className="text-gray-500 text-sm">ممتاز</p>
                                                        <p className="text-2xl font-bold text-gray-800">{statistics.excellentCount} خدام</p>
                                                        <p className="text-gray-600 text-sm">{statistics.excellentPercentage}%</p>
                                                    </div>
                                                </div>
                                            </div>
                                        ) : (
                                            // Message when no data matches filters
                                            <div className="bg-gradient-to-br from-white to-gray-50 p-8 rounded-xl shadow-lg border border-gray-100 text-center mb-8">
                                                <i className="fas fa-exclamation-triangle fa-fw mx-auto text-gray-400 mb-4 text-5xl"></i>
                                                <h3 className="text-xl font-bold text-gray-700">لا توجد بيانات</h3>
                                                <p className="text-gray-500">لم يتم العثور على بيانات مطابقة للفلاتر المحددة.</p>
                                                <button 
                                                    onClick={resetFilters}
                                                    className="mt-6 px-6 py-3 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition-all duration-300 transform hover:scale-105 shadow-md"
                                                >
                                                    إعادة تعيين الفلاتر
                                                </button>
                                            </div>
                                        )}

                                        {/* Charts Section */}
                                        <div className="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
                                            {/* Radar Chart for Axis Evaluation */}
                                            <div className="bg-gradient-to-br from-white to-gray-50 p-6 rounded-2xl shadow-lg border border-gray-100">
                                                <h2 className="text-xl font-bold text-gray-800 mb-4 flex items-center">
                                                    <i className="fas fa-chart-area fa-fw ml-2 text-xl"></i>
                                                    متوسط التقييم حسب المحاور
                                                </h2>
                                                {axisData.length > 0 ? (
                                                    <div style={{ height: '300px' }}> 
                                                        <canvas ref={radarChartRef}></canvas>
                                                    </div>
                                                ) : (
                                                    <div className="h-64 flex items-center justify-center text-gray-500">
                                                        لا توجد بيانات لعرض الرسم البياني.
                                                    </div>
                                                )}
                                            </div>
                                            
                                            {/* Top/Bottom All Servers List (Removed slice(0,15)) */}
                                            <div className="bg-gradient-to-br from-white to-gray-50 p-6 rounded-2xl shadow-lg border border-gray-100">
                                                <div className="flex justify-between items-center mb-4">
                                                    <h2 className="text-xl font-bold text-gray-800 mb-4 flex items-center">
                                                        <i className="fas fa-medal fa-fw ml-2 text-xl"></i>
                                                        أداء الخدام (حسب الفلتر)
                                                    </h2>
                                                    <div className="flex space-x-2 bg-gray-100 rounded-lg p-1 shadow-inner">
                                                        <button 
                                                            className={`px-3 py-1 rounded-md text-sm font-medium transition-all duration-200 ${performanceSort === 'desc' ? 'bg-purple-600 text-white shadow-sm' : 'text-gray-700 hover:bg-gray-200'}`}
                                                            onClick={() => setPerformanceSort('desc')}
                                                        >
                                                            الأعلى
                                                        </button>
                                                        <button 
                                                            className={`px-3 py-1 rounded-md text-sm font-medium transition-all duration-200 ${performanceSort === 'asc' ? 'bg-purple-600 text-white shadow-sm' : 'text-gray-700 hover:bg-gray-300'}`}
                                                            onClick={() => setPerformanceSort('asc')}
                                                        >
                                                            الأدنى
                                                        </button>
                                                    </div>
                                                </div>
                                                {filteredData.length > 0 ? ( 
                                                    <div className="h-[300px] overflow-y-auto pr-2">
                                                        {filteredData.map((server, index) => ( 
                                                            <div key={index} className="flex items-center mb-4 p-3 hover:bg-gray-100 rounded-lg transition-colors duration-150">
                                                                <div className="w-10 h-10 rounded-full bg-purple-100 flex items-center justify-center mr-3 flex-shrink-0">
                                                                    <span className="font-bold text-purple-700">{index + 1}</span>
                                                                </div>
                                                                <div className="flex-1 min-w-0">
                                                                    <p className="font-medium text-gray-800 truncate" title={server.fullName || server.name}>{server.fullName || server.name}</p>
                                                                    <p className="text-sm text-gray-500 truncate">{server.service} - {server.class}</p>
                                                                </div>
                                                                <div className="w-24 bg-gray-200 rounded-full h-2.5 mr-3">
                                                                    <div 
                                                                        className="h-2.5 rounded-full transition-all duration-500 ease-out" 
                                                                        style={{ 
                                                                            width: `${(server.average || 0) * 100}%`,
                                                                            backgroundColor: 
                                                                                (server.average || 0) >= 0.9 ? '#10b981' :
                                                                                (server.average || 0) >= 0.8 ? '#3b82f6' :
                                                                                (server.average || 0) >= 0.7 ? '#f59e0b' :
                                                                                (server.average || 0) >= 0.6 ? '#f97316' : '#ef4444'
                                                                        }}
                                                                    ></div>
                                                                </div>
                                                                <span className="font-bold w-14 text-gray-800 text-sm">{((server.average || 0) * 100).toFixed(1)}%</span>
                                                            </div>
                                                        ))}
                                                    </div>
                                                ) : (
                                                    <div className="h-64 flex items-center justify-center text-gray-500">
                                                        لا توجد بيانات لعرض أفضل/أسوأ الخدام.
                                                    </div>
                                                )}
                                            </div>
                                        </div>

                                        {/* Performance Levels Distribution */}
                                        {performanceLevels.length > 0 && renderPerformanceLevels()}

                                        {/* Service Distribution Doughnut Chart */}
                                        {serviceDoughnutData.labels.length > 0 && renderServiceDistributionChart()}
                                    </>
                                ) : activeTab === 'servers' ? (
                                    <>
                                        {/* Servers List Header with View Mode and Sort Options */}
                                        <div className="flex justify-between items-center mb-6">
                                            <h2 className="text-2xl font-bold text-gray-800 flex items-center">
                                                <i className="fas fa-list-alt fa-fw ml-2 text-xl"></i>
                                                قائمة الخدام ({filteredData.length})
                                            </h2>
                                            
                                            <div className="flex items-center space-x-4">
                                                {/* View Mode Toggle */}
                                                <div className="flex items-center">
                                                    <label className="mr-2 text-gray-700 font-medium">طريقة العرض:</label>
                                                    <div className="flex bg-gray-200 rounded-lg overflow-hidden shadow-inner">
                                                        <button 
                                                            className={`px-4 py-2 text-sm font-medium transition-all duration-200 ${viewMode === 'grid' ? 'bg-purple-600 text-white shadow-sm' : 'text-gray-700 hover:bg-gray-300'}`}
                                                            onClick={() => setViewMode('grid')}
                                                        >
                                                            شبكة
                                                        </button>
                                                        <button 
                                                            className={`px-4 py-2 text-sm font-medium transition-all duration-200 ${viewMode === 'list' ? 'bg-purple-600 text-white shadow-sm' : 'text-gray-700 hover:bg-gray-300'}`}
                                                            onClick={() => setViewMode('list')}
                                                        >
                                                            قائمة
                                                        </button>
                                                    </div>
                                                </div>
                                                
                                                {/* Performance Sort Toggle */}
                                                <div className="flex items-center">
                                                    <label className="mr-2 text-gray-700 font-medium">الترتيب:</label>
                                                    <div className="flex bg-gray-200 rounded-lg overflow-hidden shadow-inner">
                                                        <button 
                                                            className={`px-4 py-2 text-sm font-medium transition-all duration-200 ${performanceSort === 'desc' ? 'bg-purple-600 text-white shadow-sm' : 'text-gray-700 hover:bg-gray-300'}`}
                                                            onClick={() => setPerformanceSort('desc')}
                                                        >
                                                            الأعلى
                                                        </button>
                                                        <button 
                                                            className={`px-4 py-2 text-sm font-medium transition-all duration-200 ${performanceSort === 'asc' ? 'bg-purple-600 text-white shadow-sm' : 'text-gray-700 hover:bg-gray-300'}`}
                                                            onClick={() => setPerformanceSort('asc')}
                                                        >
                                                            الأدنى
                                                        </button>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        {/* Conditional rendering for Grid or List view */}
                                        {filteredData.length === 0 ? (
                                            // Message when no servers match filters
                                            <div className="bg-gradient-to-br from-white to-gray-50 p-8 rounded-xl shadow-lg border border-gray-100 text-center">
                                                <i className="fas fa-exclamation-triangle fa-fw mx-auto text-gray-400 mb-4 text-5xl"></i>
                                                <h3 className="text-xl font-bold text-gray-700">لا توجد بيانات</h3>
                                                <p className="text-gray-500">لم يتم العثور على خدام مطابقين للفلاتر المحددة.</p>
                                                <button 
                                                    onClick={resetFilters}
                                                    className="mt-6 px-6 py-3 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition-all duration-300 transform hover:scale-105 shadow-md"
                                                >
                                                    إعادة تعيين الفلاتر
                                                </button>
                                            </div>
                                        ) : (
                                            viewMode === 'grid' ? (
                                                // Grid View for Servers
                                                <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
                                                    {filteredData.map((server, index) => (
                                                        <div key={index} className="bg-gradient-to-br from-white to-gray-50 rounded-2xl shadow-lg border border-gray-100 overflow-hidden transform transition-all duration-300 hover:scale-102 hover:shadow-xl">
                                                            <div className="p-6">
                                                                <div className="flex justify-between items-start mb-4">
                                                                    <div>
                                                                        <h3 className="font-bold text-lg text-gray-800 mb-1 truncate" title={server.fullName || server.name}>
                                                                            {server.fullName || server.name}
                                                                        </h3>
                                                                        <div className="flex flex-wrap gap-2">
                                                                            <span className="bg-blue-100 text-blue-800 text-xs px-3 py-1 rounded-full font-medium">
                                                                                {server.service}
                                                                            </span>
                                                                            <span className="bg-green-100 text-green-800 text-xs px-3 py-1 rounded-full font-medium">
                                                                                {server.class}
                                                                            </span>
                                                                        </div>
                                                                    </div>
                                                                    <div className="bg-indigo-100 text-indigo-800 font-bold px-4 py-2 rounded-full text-sm flex-shrink-0">
                                                                        {(server.average * 100).toFixed(1)}%
                                                                    </div>
                                                                </div>
                                                                
                                                                <div className="mt-4">
                                                                    <div className="flex items-center justify-between mb-2">
                                                                        <span className="text-sm text-gray-600">مستوى الأداء</span>
                                                                        <span className="text-xs font-bold" style={{ 
                                                                            color: server.average >= 0.9 ? '#10b981' :
                                                                            server.average >= 0.8 ? '#3b82f6' :
                                                                            server.average >= 0.7 ? '#f59e0b' :
                                                                            server.average >= 0.6 ? '#f97316' : '#ef4444'
                                                                        }}>
                                                                            {server.average >= 0.9 ? 'ممتاز' :
                                                                            server.average >= 0.8 ? 'جيد جداً' :
                                                                            server.average >= 0.7 ? 'جيد' :
                                                                            server.average >= 0.6 ? 'مقبول' : 'ضعيف'}
                                                                        </span>
                                                                    </div>
                                                                    <div className="w-full bg-gray-200 rounded-full h-3">
                                                                        <div 
                                                                            className="h-3 rounded-full transition-all duration-500 ease-out" 
                                                                            style={{ 
                                                                                width: `${(server.average || 0) * 100}%`,
                                                                                backgroundColor: 
                                                                                (server.average || 0) >= 0.9 ? '#10b981' :
                                                                                (server.average || 0) >= 0.8 ? '#3b82f6' :
                                                                                (server.average || 0) >= 0.7 ? '#f59e0b' :
                                                                                (server.average || 0) >= 0.6 ? '#f97316' : '#ef4444'
                                                                            }}
                                                                        ></div>
                                                                    </div>
                                                                </div>
                                                                
                                                                <button 
                                                                    onClick={() => toggleServerDetails(server.name)}
                                                                    className="w-full mt-6 py-2 text-indigo-600 hover:text-indigo-800 flex items-center justify-center font-medium rounded-lg bg-indigo-50 hover:bg-indigo-100 transition-colors duration-200"
                                                                >
                                                                    {expandedServers[server.name] ? 'إخفاء التفاصيل' : 'عرض التفاصيل'}
                                                                    {expandedServers[server.name] ? <i className="fas fa-chevron-up fa-fw ml-1 text-sm"></i> : <i className="fas fa-chevron-down fa-fw ml-1 text-sm"></i>}
                                                                </button>
                                                            </div>
                                                            
                                                            {expandedServers[server.name] && (
                                                                <div className="bg-gray-50 p-6 border-t border-gray-100">
                                                                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                                                        <div>
                                                                            <h3 className="font-semibold text-green-700 mb-2 flex items-center">
                                                                                <i className="fas fa-check-circle fa-fw ml-2 text-xl"></i>
                                                                                نقاط القوة:
                                                                            </h3>
                                                                            <p className="text-gray-700 bg-green-50 p-3 rounded-lg text-sm whitespace-pre-wrap">{server.strengths || 'لا يوجد'}</p>
                                                                        </div>
                                                                        <div>
                                                                            <h3 className="font-semibold text-red-700 mb-2 flex items-center">
                                                                                <i className="fas fa-times-circle fa-fw ml-2 text-xl"></i>
                                                                                نقاط الضعف:
                                                                            </h3>
                                                                            <p className="text-gray-700 bg-red-50 p-3 rounded-lg text-sm whitespace-pre-wrap">{server.weaknesses || 'لا يوجد'}</p>
                                                                        </div>
                                                                        <div className="md:col-span-2">
                                                                            <h3 className="font-semibold text-gray-700 mb-2 flex items-center">
                                                                                <i className="fas fa-sticky-note fa-fw ml-2 text-xl"></i>
                                                                                ملاحظات:
                                                                            </h3>
                                                                            <p className="text-gray-700 bg-gray-100 p-3 rounded-lg text-sm whitespace-pre-wrap">{server.notes || 'لا يوجد'}</p>
                                                                        </div>
                                                                        <div className="col-span-full">
                                                                            <button
                                                                                onClick={() => generateSuggestionsForServer(server)}
                                                                                className="w-full py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition-all duration-300 transform hover:scale-105 shadow-md flex items-center justify-center"
                                                                                disabled={isGeneratingSuggestions[server.name]}
                                                                            >
                                                                                {isGeneratingSuggestions[server.name] ? (
                                                                                    <>
                                                                                        <i className="fas fa-spinner fa-spin ml-2"></i>
                                                                                        جاري التوليد...
                                                                                    </>
                                                                                ) : (
                                                                                    <>
                                                                                        <i className="fas fa-magic ml-2"></i>
                                                                                        ✨ اقتراحات تحسين ✨
                                                                                                        </>
                                                                                )}
                                                                            </button>
                                                                            {generatedSuggestions[server.name] && (
                                                                                <div className="mt-4 p-3 bg-blue-50 rounded-lg border border-blue-200 text-blue-800 text-sm whitespace-pre-wrap">
                                                                                    <h4 className="font-bold mb-2 flex items-center">
                                                                                        <i className="fas fa-lightbulb ml-2"></i>
                                                                                        اقتراحات الذكاء الاصطناعي:
                                                                                        <button onClick={() => setGeneratedSuggestions(prev => ({ ...prev, [server.name]: '' }))} className="mr-2 text-blue-600 hover:text-blue-800 text-xs">
                                                                                            <i className="fas fa-times-circle"></i> مسح
                                                                                        </button>
                                                                                    </h4>
                                                                                    {generatedSuggestions[server.name]}
                                                                                </div>
                                                                            )}
                                                                        </div>
                                                                    </div>
                                                                </div>
                                                            )}
                                                        </div>
                                                    ))}
                                                </div>
                                            ) : (
                                                <div className="bg-white rounded-2xl shadow-lg border border-gray-100 overflow-hidden">
                                                    <div className="overflow-x-auto">
                                                        <table className="min-w-full divide-y divide-gray-200">
                                                            <thead className="bg-gray-50">
                                                                <tr>
                                                                    <th className="px-6 py-3 text-right text-xs font-medium text-gray-600 uppercase tracking-wider">الاسم</th>
                                                                    <th className="px-6 py-3 text-right text-xs font-medium text-gray-600 uppercase tracking-wider">الخدمة</th>
                                                                    <th className="px-6 py-3 text-right text-xs font-medium text-gray-600 uppercase tracking-wider">الفصل</th>
                                                                    <th className="px-6 py-3 text-right text-xs font-medium text-gray-600 uppercase tracking-wider">التقييم</th>
                                                                    <th className="px-6 py-4 text-right text-xs font-medium text-gray-600 uppercase tracking-wider">التفاصيل</th>
                                                                </tr>
                                                            </thead>
                                                            <tbody className="bg-white divide-y divide-gray-200">
                                                                {filteredData.map((server, index) => (
                                                                    <React.Fragment key={index}>
                                                                        <tr className={`${index % 2 === 0 ? 'bg-white' : 'bg-gray-50'} hover:bg-gray-100 transition-colors duration-150`}>
                                                                            <td className="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900" title={server.fullName || server.name}>
                                                                                {server.fullName || server.name}
                                                                            </td>
                                                                            <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-600">{server.service}</td>
                                                                            <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-600">{server.class}</td>
                                                                            <td className="px-6 py-4 whitespace-nowrap">
                                                                                <div className="flex items-center">
                                                                                    <div className="w-24 bg-gray-200 rounded-full h-2.5 mr-2">
                                                                                        <div 
                                                                                            className="h-2.5 rounded-full transition-all duration-500 ease-out" 
                                                                                            style={{ 
                                                                                                width: `${(server.average || 0) * 100}%`,
                                                                                                backgroundColor: 
                                                                                                    (server.average || 0) >= 0.9 ? '#10b981' :
                                                                                                    (server.average || 0) >= 0.8 ? '#3b82f6' :
                                                                                                    (server.average || 0) >= 0.7 ? '#f59e0b' :
                                                                                                    (server.average || 0) >= 0.6 ? '#f97316' : '#ef4444'
                                                                                            }}
                                                                                        ></div>
                                                                                    </div>
                                                                                    <span className="text-sm font-bold text-gray-800">
                                                                                        {((server.average || 0) * 100).toFixed(1)}%
                                                                                    </span>
                                                                                </div>
                                                                            </td>
                                                                            <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-600">
                                                                                <button 
                                                                                    onClick={() => toggleServerDetails(server.name)}
                                                                                    className="text-indigo-600 hover:text-indigo-800 flex items-center font-medium transition-colors duration-200"
                                                                                >
                                                                                    {expandedServers[server.name] ? 'إخفاء التفاصيل' : 'عرض التفاصيل'}
                                                                                    {expandedServers[server.name] ? <i className="fas fa-chevron-up fa-fw ml-1 text-sm"></i> : <i className="fas fa-chevron-down fa-fw ml-1 text-sm"></i>}
                                                                                </button>
                                                                            </td>
                                                                        </tr>
                                                                        {expandedServers[server.name] && (
                                                                            <tr>
                                                                                <td colSpan="5" className="px-6 py-4 bg-gray-100">
                                                                                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                                                                        <div>
                                                                                            <h3 className="font-semibold text-green-700 mb-2 flex items-center">
                                                                                                <i className="fas fa-check-circle fa-fw ml-2 text-xl"></i>
                                                                                                نقاط القوة:
                                                                                            </h3>
                                                                                            <p className="text-gray-700 bg-green-50 p-3 rounded-lg text-sm whitespace-pre-wrap">{server.strengths || 'لا يوجد'}</p>
                                                                                        </div>
                                                                                        <div>
                                                                                            <h3 className="font-semibold text-red-700 mb-2 flex items-center">
                                                                                                <i className="fas fa-times-circle fa-fw ml-2 text-xl"></i>
                                                                                                نقاط الضعف:
                                                                                            </h3>
                                                                                            <p className="text-gray-700 bg-red-50 p-3 rounded-lg text-sm whitespace-pre-wrap">{server.weaknesses || 'لا يوجد'}</p>
                                                                                        </div>
                                                                                        <div className="md:col-span-2">
                                                                                            <h3 className="font-semibold text-gray-700 mb-2 flex items-center">
                                                                                                <i className="fas fa-sticky-note fa-fw ml-2 text-xl"></i>
                                                                                                ملاحظات:
                                                                                            </h3>
                                                                                            <p className="text-gray-700 bg-gray-100 p-3 rounded-lg text-sm whitespace-pre-wrap">{server.notes || 'لا يوجد'}</p>
                                                                                        </div>
                                                                                        <div className="col-span-full">
                                                                                            <button
                                                                                                onClick={() => generateSuggestionsForServer(server)}
                                                                                                className="w-full py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition-all duration-300 transform hover:scale-105 shadow-md flex items-center justify-center"
                                                                                                disabled={isGeneratingSuggestions[server.name]}
                                                                                            >
                                                                                                {isGeneratingSuggestions[server.name] ? (
                                                                                                    <>
                                                                                                        <i className="fas fa-spinner fa-spin ml-2"></i>
                                                                                                        جاري التوليد...
                                                                                                    </>
                                                                                                ) : (
                                                                                                    <>
                                                                                                        <i className="fas fa-magic ml-2"></i>
                                                                                                        ✨ اقتراحات تحسين ✨
                                                                                                        </>
                                                                                                )}
                                                                                            </button>
                                                                                            {generatedSuggestions[server.name] && (
                                                                                                <div className="mt-4 p-3 bg-blue-50 rounded-lg border border-blue-200 text-blue-800 text-sm whitespace-pre-wrap">
                                                                                                    <h4 className="font-bold mb-2 flex items-center">
                                                                                                        <i className="fas fa-lightbulb ml-2"></i>
                                                                                                        اقتراحات الذكاء الاصطناعي:
                                                                                                        <button onClick={() => setGeneratedSuggestions(prev => ({ ...prev, [server.name]: '' }))} className="mr-2 text-blue-600 hover:text-blue-800 text-xs">
                                                                                                            <i className="fas fa-times-circle"></i> مسح
                                                                                                        </button>
                                                                                                    </h4>
                                                                                                    {generatedSuggestions[server.name]}
                                                                                                </div>
                                                                                            )}
                                                                                        </div>
                                                                                    </div>
                                                                                </td>
                                                                            </tr>
                                                                        )}
                                                                    </React.Fragment>
                                                                ))}
                                                            </tbody>
                                                        </table>
                                                    </div>
                                                </div>
                                            )
                                        )}
                                    </>
                                ) : activeTab === 'mindmap' ? (
                                    <MindMap data={filteredData} selectedService={selectedService} /> 
                                ) : null}
                            </>
                        )}
                    </main>
                    {/* Server List Modal */}
                    {isModalOpen && (
                        <ServerListModal 
                            isOpen={isModalOpen} 
                            onClose={closeServerListModal} 
                            level={modalContent.level} 
                            servers={modalContent.servers} 
                        />
                    )}
                    {/* Custom Message Display */}
                    <CustomMessage message={message} onClose={() => setMessage(null)} />
                </div>
            );
        };
    </script>

    <!-- Initialization Script (must be defined after React components) -->
    <script>
        /**
         * Renders the React dashboard with the provided data.
         * @param {Array} dataToDisplay - The data to be displayed in the dashboard.
         */
        const renderDashboard = (dataToDisplay) => {
            console.log('renderDashboard called with data:', dataToDisplay); // Added log
            const rootElement = document.getElementById('react-dashboard-root');
            if (!rootElement) {
                console.error('React root element not found!');
                return; // Exit if root element is not found
            }
            if (!reactRoot) {
                // Create a React root if it's doesn't exist
                reactRoot = ReactDOM.createRoot(rootElement);
                console.log('React root created.'); // Added log
            }
            globalDashboardData = dataToDisplay; // Store data globally
            // Render the ServerEvaluationDashboard React component with the initial data
            // ServerEvaluationDashboard is now defined globally via window.ServerEvaluationDashboard
            reactRoot.render(React.createElement(window.ServerEvaluationDashboard, { initialData: dataToDisplay }));
        };

        // Initial render: show file upload section on DOMContentLoaded
        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('fileUploadSection').style.display = 'block';
            document.getElementById('loadingScreen').style.display = 'none';
            // Wait for window.ServerEvaluationDashboard to be defined before rendering
            const checkReactReady = setInterval(() => {
                if (window.ServerEvaluationDashboard) {
                    clearInterval(checkReactReady);
                    renderDashboard([]); // Render an empty dashboard initially
                }
            }, 50); // Check every 50ms
        });
    </script>
</body>
</html>
